<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Attendance Recorder — Colorful</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1: #f6f8ff; /* light */
      --bg2: #fff9fb;
      --accent1: #7c3aed; /* purple */
      --accent2: #06b6d4; /* teal */
      --glass: rgba(255,255,255,0.75);
      --card-bg: rgba(255,255,255,0.9);
      --muted: #5b6770;
      --text: #0b1220;
      --success: #10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background: radial-gradient(800px 300px at 10% 8%, rgba(124,58,237,0.08), transparent 8%), radial-gradient(600px 220px at 90% 90%, rgba(6,182,212,0.04), transparent 10%), linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text)}

    /* center everything horizontally and vertically */
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:48px 20px;
    }

    .card{
      width:100%;
      max-width:980px;
      border-radius:16px;
      padding:28px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,255,0.9));
      box-shadow: 0 12px 40px rgba(25,35,50,0.08);
      backdrop-filter: blur(6px) saturate(120%);
      border: 1px solid rgba(16,24,40,0.04);
      display:grid;
      grid-template-columns: 1fr;
      gap:22px;
      transition: transform 300ms cubic-bezier(.2,.9,.3,1);
    }
    .card:hover{ transform: translateY(-6px) }

    header{display:flex;align-items:center;gap:16px;margin-bottom:6px}
    .logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;box-shadow:0 8px 22px rgba(124,58,237,0.12)}
    .title{font-size:18px;font-weight:700;margin:0}
    .subtitle{font-size:13px;color:var(--muted);margin:0}

    .main{display:flex;flex-direction:column;gap:18px}
    .controls{display:flex;gap:12px;align-items:center}

    button.primary{appearance:none;border:0;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;box-shadow:0 10px 30px rgba(124,58,237,0.12);transition: transform 160ms ease, box-shadow 160ms ease}
    button.ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--muted);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition: background 160ms ease, transform 160ms ease}
    button.primary:active, button.ghost:active{ transform: translateY(1px) }
    button:disabled{ opacity:0.5; cursor:not-allowed }

    .status{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:var(--glass);border:1px solid rgba(16,24,40,0.04);font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--success);box-shadow:0 6px 14px rgba(16,185,129,0.12)}

    .card-right{display:flex;flex-direction:column;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.96)); border:1px solid rgba(16,24,40,0.04);min-height:200px;align-self:start}

    .history{list-style:none;margin:0;padding:8px;display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:420px}
    .history li{padding:12px 14px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(16,24,40,0.04);font-size:14px;color:var(--text);display:flex;justify-content:space-between;gap:12px;align-items:center;transition: transform 220ms ease, opacity 220ms ease}
    .history li .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .history li.new{ transform: translateY(-6px); opacity:0; animation: appear 420ms forwards }
    @keyframes appear{ to{ transform: translateY(0); opacity:1 } }

    .meta{font-size:12px;color:var(--muted)}
    pre#immediate{white-space:pre-wrap;margin:0;padding:12px;border-radius:10px;min-height:44px;background:#f3f6ff;border:1px solid rgba(16,24,40,0.04);color:var(--text);font-size:13px}
    footer.small{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}

    /* center layout on very wide screens with breathing space to the right */
    @media (min-width:1200px){
      .wrap{padding-left:60px;padding-right:60px}
    }

    @media (max-width:920px){.card{grid-template-columns:1fr}.card-right{order:-1}}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card" aria-labelledby="attend-title">
      <div class="main">
        <header>
          <div class="logo" aria-hidden>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
              <rect x="3" y="3" width="18" height="18" rx="5" fill="white" fill-opacity="0.08"></rect>
              <path d="M7 11h10M7 15h6M9 7h6" stroke="white" stroke-opacity="0.95" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <h1 id="attend-title" class="title">Attendance Recorder</h1>
            <p class="subtitle">Realtime audio check-in:</p>
          </div>
        </header>

        <div class="controls" role="group" aria-label="recorder controls">
          <button id="startBtn" class="primary">Start recording</button>
          <button id="stopBtn" class="ghost" disabled>Stop</button>

          <div style="flex:1"></div>

          <div class="status" id="connStatus"><span class="dot" id="dot"></span><span id="statusText">Disconnected</span></div>
        </div>

        <!-- <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:13px">Immediate server response</label>
          <pre id="immediate">— awaiting upload —</pre>
        </div> -->

        <div>
          <p style="margin:0;color:var(--muted);font-size:13px">Tips: Use a headset for clearer audio. The UI shows realtime updates pushed from the server.</p>
        </div>

        <!-- <footer class="small">
          <div>Built for modern browsers · WebAudio + Socket.IO</div>
          <div id="socketId" style="text-align:right;color:var(--muted)"></div>
        </footer> -->
      </div>

      <div class="card-right" aria-labelledby="history-title">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <h3 id="history-title" style="margin:0;font-size:15px;font-weight:700">Attendace:</h3>
            <p class="meta">Realtime entries are added to the list below</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="refreshBtn" class="ghost" title="Refresh">Refresh</button>
            <button id="clearBtn" class="ghost" title="Clear">Clear</button>
          </div>
        </div>
        <ul id="history" class="history" aria-live="polite" aria-atomic="true"></ul>
        <div style="margin-top:6px">
          <button id="downloadBtn" class="primary" style="width:100%">Download CSV</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
  try {
    if (window.AndroidBridge && typeof window.AndroidBridge.notifyPageLoaded === 'function') {
      window.AndroidBridge.notifyPageLoaded();
    }
  } catch (e) { console.warn(e); }
  // ---- configuration (replace with your ngrok/host) ----
  const ngrokUrl = " https://sad-jeans-cheat.loca.lt"; // update to your URL
  const recordedEndpoint = ngrokUrl + "/recorded";
  const latestEndpoint = ngrokUrl + "/latest?count=50";

  // ---- connect socket.io ----
  const socket = io(ngrokUrl, { transports: ['websocket'], reconnectionAttempts: 6, timeout: 20000 });

  const connDot = document.getElementById('dot');
  const statusText = document.getElementById('statusText');
  const socketIdEl = document.getElementById('socketId');

  function setStatus(connected){
    if(connected){ connDot.style.background = 'linear-gradient(90deg,#10b981,#059669)'; statusText.textContent = 'Connected'; }
    else { connDot.style.background = '#ffb4b4'; statusText.textContent = 'Disconnected'; socketIdEl.textContent = '' }
  }

  socket.on('connect', () => { setStatus(true); socketIdEl.textContent = 'id: ' + socket.id; console.log('Socket connected', socket.id); });
  socket.on('disconnect', ()=> setStatus(false));
  socket.on('connect_error', (err)=>{ console.warn('connect_error', err); setStatus(false) });

  socket.on('server_ack', (msg)=> console.log('Server ack:', msg));

  socket.on('new_chunks', (data)=>{
    try{
      const ul = document.getElementById('history');
      (data.rows || []).forEach(r => {
        const li = document.createElement('li');
        const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
        const main = document.createElement('div'); main.textContent = r.text || '—';
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = r.date || '';
        left.appendChild(main); left.appendChild(meta);
        li.appendChild(left);
        const badge = document.createElement('div'); badge.textContent = 'Live'; badge.style.fontSize='12px'; badge.style.opacity='0.9';
        li.appendChild(badge);
        li.classList.add('new');
        ul.insertBefore(li, ul.firstChild);
      });
    }catch(e){console.warn('new_chunks handler', e)}
  });

  // ---- audio recording ----
  let mediaRecorder, audioChunks = [];
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');   
  const refreshBtn = document.getElementById('refreshBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  // ---------- added: permission-aware web recording with native fallback ----------
  // native bridge wrappers (NativeRecorder is provided by Android MainActivity)
  function nativeStart() {
    try {
      if (window.NativeRecorder && window.NativeRecorder.startRecording) {
        window.NativeRecorder.startRecording();
      } else {
        console.warn('NativeRecorder not available');
      }
    } catch (e) { console.error(e); }
  }
  function nativeStopAndUpload() {
    try {
      if (window.NativeRecorder && window.NativeRecorder.stopRecordingAndUpload) {
        window.NativeRecorder.stopRecordingAndUpload();
      } else {
        console.warn('NativeRecorder not available');
      }
    } catch (e) { console.error(e); }
  }

  // JS callbacks invoked by native Java (RecorderBridge)
  window.onNativeRecordingStarted = function() {
    startBtn.disabled = true;
    stopBtn.disabled = false;
    startBtn.textContent = 'Recording… (native)';
  };

  window.onNativeUploadComplete = function(data) {
    console.log('Native upload complete', data);
    try {
      const json = typeof data === 'string' ? JSON.parse(data) : data;
      if (json && json.chunks) {
        json.chunks.forEach(c => {
          const ul = document.getElementById('history');
          const li = document.createElement('li');
          const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
          const main = document.createElement('div'); main.textContent = c.text || '—';
          const meta = document.createElement('div'); meta.className='meta'; meta.textContent = c.date || '';
          left.appendChild(main); left.appendChild(meta); li.appendChild(left); ul.insertBefore(li, ul.firstChild);
        });
      }
    } catch (e) {
      console.log('onNativeUploadComplete: response not JSON', e);
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.textContent = 'Start recording';
  };

  window.onNativeUploadError = function(msg) {
    alert('Upload error: ' + msg);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.textContent = 'Start recording';
  };

  window.onNativeRecordingError = function(msg) {
    alert('Recording error: ' + msg);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.textContent = 'Start recording';
  };

  // permission-aware web recording + native fallback
  async function startRecordingWeb() {
    audioChunks = [];
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
      startBtn.disabled = true; stopBtn.disabled = false; startBtn.textContent = 'Recording…';
      return true;
    } catch (err) {
      console.warn('Web getUserMedia failed', err);
      return false;
    }
  }

  async function stopRecordingWebAndUpload() {
    if (!mediaRecorder) return;
    mediaRecorder.stop();
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const form = new FormData(); form.append('file', blob, 'recording.webm');
      try {
        const res = await fetch(recordedEndpoint, { method: 'POST', body: form });
        if (!res.ok) { document.getElementById('immediate') && (document.getElementById('immediate').innerText = 'Error: ' + res.status); return; }
        const json = await res.json(); document.getElementById('immediate') && (document.getElementById('immediate').innerText = JSON.stringify(json, null, 2));
        if (json && Array.isArray(json.chunks)) {
          json.chunks.forEach(c => {
            const ul = document.getElementById('history');
            const li = document.createElement('li');
            const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
            const main = document.createElement('div'); main.textContent = c || c.text || '—';
            const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (new Date()).toLocaleString();
            left.appendChild(main); left.appendChild(meta); li.appendChild(left); ul.insertBefore(li, ul.firstChild);
          });
        }
      } catch (err) {
        console.error('Upload failed', err);
        document.getElementById('immediate') && (document.getElementById('immediate').innerText = 'Upload failed — see console');
      } finally {
        startBtn.disabled = false; stopBtn.disabled = true; startBtn.textContent = 'Start recording';
      }
    };
  }

  // Start/Stop handlers (use web path first; fallback to native)
  startBtn.addEventListener('click', async () => {
    const ok = await startRecordingWeb();
    if (!ok) {
      console.log('Falling back to native recorder');
      nativeStart();
    }
  });

  stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      stopRecordingWebAndUpload();
    } else {
      nativeStopAndUpload();
    }
  });
  // ---------- end added section ----------

  async function loadLatestOnce(){
    try{ const r = await fetch(latestEndpoint); if(r.ok){ const j = await r.json(); const ul = document.getElementById('history'); ul.innerHTML = ''; (j.rows || []).reverse().forEach(row => { const li = document.createElement('li'); const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column'; const main = document.createElement('div'); main.textContent = row.text || '—'; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = row.date || ''; left.appendChild(main); left.appendChild(meta); li.appendChild(left); ul.appendChild(li); }); } }catch(e){ console.warn('loadLatestOnce failed', e) }
  }

  refreshBtn.addEventListener('click', loadLatestOnce);
  clearBtn.addEventListener('click', ()=>{ if(confirm('Clear local history view?')) document.getElementById('history').innerHTML = '' });

  downloadBtn.addEventListener('click', () => {
    const lis = Array.from(document.querySelectorAll('#history li'));

    // helper: format "2025-11-21 16:26:10" -> "21-Jan-2025"
    function formatDate(dateText) {
      if (!dateText) return '';
      // convert "YYYY-MM-DD HH:MM:SS" -> "YYYY-MM-DDTHH:MM:SS"
      const clean = dateText.trim().replace(' ', 'T');
      const d = new Date(clean);
      if (isNaN(d.getTime())) return dateText; // fallback if parsing fails
      const day = String(d.getDate()).padStart(2, '0');
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const month = monthNames[d.getMonth()];
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }

    const rows = [];

    lis.forEach(li => {
      const mainEl = li.querySelector('div > div:not(.meta)'); // first text div
      const metaEl = li.querySelector('.meta');

      const fullText = (mainEl?.textContent || '').trim();
      const dateRaw  = (metaEl?.textContent || '').trim();

      let name = '';
      let className = '';

      // Try to parse: "my name is X and class Y"
      const m = fullText.match(/my name is\s+(.+?)\s+and\s+class\s+(.+?)(\.|,|$)/i);
      if (m) {
        name = m[1].trim();
        className = m[2].trim();
      } else {
        // fallback: put everything into "name" if pattern not matched
        name = fullText;
      }

      const formattedDate = formatDate(dateRaw);
      rows.push([name, className, formattedDate]);
    });

  // Build CSV: header + rows
  const header = ['name', 'class', 'date'];
  const csvLines = [header, ...rows].map(cols =>
    cols
      .map(v => {
        const s = String(v ?? '');
        // escape quotes
        return `"${s.replace(/"/g, '""')}"`;
      })
      .join(',')
  );

  const csvContent = csvLines.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'attendance.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

  // initial load
  loadLatestOnce();
  </script>
</body>
</html>


